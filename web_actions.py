# ุงูููู: web_actions.py (ุงูุฅุตุฏุงุฑ ุงูููุงุฆู ูู Requests)

import requests
from bs4 import BeautifulSoup
import json
import time

# ูุงููุณ ูุชุญุฏูุฏ ID ุงูููุทูุฉ ุจูุงุกู ุนูู ุงูุงุณู (ูุทููุจ ูู Select Box)
AREA_IDS = {
    "ุชูุงุทุน ุฌูุงุจ": "1", "ุงูุงุณูุฏุฉ": "2", "ูุญููุฉ ุงูุณูู": "3", "ุฌุณุฑ ูุญููุฉ": "4", 
    "ุฌูููุฑ": "5", "ุงุจู ูุบูุฑุฉ": "6", "ูุญููุฉ ุทุฑูู ุงููุญุทุฉ": "7", "ูุญููุฉ ุดุงุฑุน ุงูุงูุฏูุณ": "8", 
    "ูุญููุฉ ุตูุญุฉ ุงูุดุท": "9", "ุฌูููุฑ ุญุฒุจุฉ 1": "10", "ุฌูููุฑ ุญุฒุจุฉ .2": "11", "ุจุงุจ ููุฏุงู": "12", 
    # ... ููุฏุฑ ูุถูู ุจุงูู ุงูููุงุทู ุญุณุจ ุงูุญุงุฌุฉ
    # ุจูุง ุฅููุง ูุญุชุงุฌ ุฌูููุฑ ููุทุ ูุฑูุฒ ุนูููุง
    # ๐ด ูุฑุฌู ุฅุถุงูุฉ ุจุงูู ุงูููุงุทู ูุงุญูุงู ุฅุฐุง ุงุญุชุฌุชูุง
}

# ************************************************
# ๐ด ุฏุงูุฉ ุชูููุฐ ุนูููุฉ ุฅุถุงูุฉ ุงูุทูุจ (ุจุงุณุชุฎุฏุงู Requests)
# ************************************************
def perform_add_order(order_details: list, delivery_url: str):
    
    # ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุงููู ุชุฌููุง ูู ุงูุชููุฌุฑุงู:
    item_type = order_details[0].strip()    # ููุน ุงูุทูุจูุฉ (ูุณูุงู)
    price = order_details[1].strip()        # ุงูุณุนุฑ (12)
    area_name = order_details[2].strip()    # ุงูููุทูุฉ (ุฌูููุฑ)
    phone_number = order_details[3].strip() # ุงูุฑูู (077...)
    time_text = order_details[4].strip()    # ุงูููุช (ูุณู)
    
    # *******************************************************************
    # 1. ุงููุฑุญูุฉ ุงูุฃููู: ุงุณุชุฎุฑุงุฌ ID ุงูููุทูุฉ
    # *******************************************************************
    # ๐ด ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุทูุฉุ ูุฑุณู ูููุฉ ูุงุฑุบุฉ
    city_id = AREA_IDS.get(area_name, "") 
    
    # *******************************************************************
    # 2. ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฅุฑุณุงู ุงูุทูุจ (POST Request)
    # *******************************************************************
    
    post_url = delivery_url 
    
    # ๐ด ุงูุจูุงูุงุช ุงููู ูุงุฒู ูุฑุณููุง ุงูุจูุช ูููููุน (ุงูุฃุณูุงุก ุงูุญููููุฉ ูู ุงูููุฏ):
    payload = {
        # ุงูุญููู ุงููููุฉ
        'order_type': item_type,       
        'price': price,                
        'city_id': city_id,            # ๐ด ูุฑุณู ID ุงูููุทูุฉ (ูุซูุงู: 5 ูู ุฌูููุฑ)
        'phone': phone_number,         
        'date_note': time_text,        
        
        # ุงูุญููู ุงูุซุงูููุฉ (ูุฑุณููุง ูุงุฑุบุฉ ุฃู ุจูููุชูุง ุงูุงูุชุฑุงุถูุฉ)
        'is_paid': "0",                 # 'ูู ุดู ูุงุตูุ' (0 = ูุงุ ุฅุฐุง ูุงู ุบูุฑ ูุญุฏุฏ)
        'phone2': "",                   # ุฑูู ูุงุชู ุซุงูู ุบูุฑ ุถุฑูุฑู
        'pic': "",                      # ุตูุฑุฉ ุงูุทูุจูุฉ (ููู ูุงุฑุบ)
        'note': "",                     # ููุงุญุธุงุช (ูุงุฑุบุฉ)
        
        # ุฒุฑ ุงูุฅุถุงูุฉ (ูุฌุจ ุฃู ูููู ููุฌูุฏุงู)
        'addnew': 'ุงุถุงูุฉ ุงูุทูุจูุฉ'      # ๐ด ุงุณู ุงูู name ูุฒุฑ ุงูุชุฃููุฏ
    }
    
    # ุฅุฑุณุงู ุงูุจูุงูุงุช
    try:
        # ๐ด ูุงุฒู ูุญุฏุฏ ููุน ุงููุญุชูู ุงููุฑุณู Headers
        headers = {
            'User-Agent': 'TelegramBot/1.0',
            'Referer': delivery_url,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
        
        response = requests.post(post_url, data=payload, headers=headers)
        
        # ูุญุต ุงูุฑุฏ:
        if response.status_code == 200:
            # ุจูุง ุฅู ุงููููุน ูุนูุฏ ุชุญููู ุงูุตูุญุฉ ููุทูุน ุตูุฑุฉ ูุฌุงุญุ 
            # ูุจุญุซ ุนู ุงูููุฏ ุงููู ูุธูุฑ ููุง ููุดู ุฃู ุฑุณุงูุฉ ุงูุชุญููู
            if "location.replace" in response.text:
                # ๐ด ูุฐุง ุงูุฑุฏ ูุฌู ููุง ุงูุนูููุฉ ุชูุฌุญุ ูุงููููุน ูุทูุจ ุชุญููู ุงูุตูุญุฉ
                return "โ ุชู ุฅุถุงูุฉ ุงูุทูุจ ุจูุฌุงุญ (ุชู ุฅุฑุณุงู ุฌููุน ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ)."
            else:
                # ุฅุฐุง ุฑุฏ ุจู 200 ููู ุจุฏูู ุณูุฑูุจุช ุงูุชุญูููุ ูุฐุง ูุนูุงู ุฃู ุงูุฅุถุงูุฉ ูุดูุช
                return f"โ ูุดู: ุชู ุฑูุถ ุงูุจูุงูุงุช ูู ูุจู ุงููููุน. ูุฑุฌู ูุฑุงุฌุนุฉ ุจูุงูุงุชู."
        else:
            return f"โ ูุดู ุงูุฅุฑุณุงู. ุญุงูุฉ ุงูุฑุฏ: {response.status_code}. "

    except Exception as e:
        return f"โ ุตุงุฑ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ: {e}"
