# ุงูููู: web_actions.py (ุงูุฅุตุฏุงุฑ ุงูููุงุฆู ูุญู ูุดููุฉ ุงูุญููู ุงููุงูุตุฉ)

import requests
from bs4 import BeautifulSoup
import json
import time

# ************************************************
# ๐ด ุฏุงูุฉ ุชูููุฐ ุนูููุฉ ุฅุถุงูุฉ ุงูุทูุจ (ุจุงุณุชุฎุฏุงู Requests)
# ************************************************
def perform_add_order(order_details: list, delivery_url: str):
    
    # ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ุงููู ุชุฌููุง ูู ุงูุชููุฌุฑุงู:
    item_type = order_details[0].strip()    # ุงูููุน (ูุณูุงู)
    price = order_details[1].strip()        # ุงูุณุนุฑ (12)
    area_name = order_details[2].strip()    # ุงูููุทูุฉ (ุฌูููุฑ)
    phone_number = order_details[3].strip() # ุงูุฑูู (077...)
    time_text = order_details[4].strip()    # ุงูููุช (ูุณู)
    
    # ๐ด ููุงุญุธุฉ: ุจูุง ุฃููุง ูุง ูุนุฑู ุฃุณูุงุก ุงูุญููู ุงูุญููููุฉ ูู ุงููููุนุ ุณูุณุชุฎุฏู
    # ุชุฎูููุงุช ุฃูุซุฑ ุดููุนุงู ููุชุฃูุฏ ูู ุฅุฑุณุงู ุฌููุน ุงูุญููู ุงูุซูุงููุฉ.
    
    # *******************************************************************
    # 1. ูุฑุญูุฉ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช (Payload) 
    # *******************************************************************

    # ๐ด ูุฐุง ูู ุงูุฑุงุจุท ุงููู ุฑุงุญ ูุฑุณู ุนููู ุงูุจูุงูุงุช (ุบุงูุจุงู ููุณ ุฑุงุจุท ุงูุตูุญุฉ)
    post_url = delivery_url 
    
    # ๐ด ุงูุจูุงูุงุช ุงููู ูุงุฒู ูุฑุณููุง ุงูุจูุช ูููููุน (ูุทุงุจูุฉ ูุฌููุน ุญููู ุงูููุฑู):
    payload = {
        # ุงูุญููู ุงูุฎูุณุฉ ุงููู ุฏุฒูุชูุง:
        'type': item_type,             # ุงุณู ุงูุญูู ูุชุฎููู 'ููุน ุงูุทูุจ'
        'price_no_delivery': price,    # ุงุณู ุงูุญูู ูุชุฎููู 'ุณุนุฑ ุงูุทูุจ'
        'area_name': area_name,        # ุงุณู ุงูุญูู ูุชุฎููู 'ููุทูุฉ ุงูุฒุจูู'
        'phone': phone_number,         # ุงุณู ุงูุญูู ูุชุฎููู 'ุฑูู ุงูุฒุจูู'
        'order_time': time_text,       # ุงุณู ุงูุญูู ูุชุฎููู 'ููุช ุงูุทูุจ'
        
        # ุงูุญููู ุงููู ุฃูุฏุช ุฅููุง 'ุบูุฑ ูููุฉ' (ููู ูุฌุจ ุฅุฑุณุงููุง ูุงุฑุบุฉ):
        'phone_second': "",            # ุญูู 'ุฑูู ุซุงูู ููุฒุจูู' (ูุงุฑุบ)
        'notes': "",                   # ุญูู 'ููุงุญุธุงุช' (ูุงุฑุบ)
        'image': "",                   # ุญูู 'ุตูุฑุฉ ุงูุทูุจูุฉ' (ูุงุฑุบ)
        'is_done': "0",                # ุญูู ุชุฎูููู ูู 'ูู ุดู ูุงุตูุ' (0 = ูุง)
        
        # ุญูู ุฒุฑ ุงูุฅุถุงูุฉ (ููู ููุชุฃููุฏ):
        'submit': 'ุฅุถุงูุฉ ุงูุทูุจูุฉ'       # ุชุฎููู ูุงุณู ุฒุฑ ุงูุชุฃููุฏ
    }
    
    # *******************************************************************
    # 2. ูุฑุญูุฉ ุฅุฑุณุงู ุงูุทูุจ (POST Request)
    # *******************************************************************
    
    try:
        response = requests.post(post_url, data=payload)
        
        # ูุญุต ุงูุฑุฏ:
        if response.status_code == 200:
            # ุงููููุน ุฑุฏ ุจููุฏ 200ุ ุงูุขู ูุญุงูู ุงูุชุฃูุฏ ูู ุฑุณุงูุฉ ุงููุฌุงุญ
            
            # ุจูุง ุฅูู ุฐูุฑุช ุฃู ุงููููุน ูุญูู ุงูุตูุญุฉ ูู ุฌุฏูุฏ ุจุนุฏ ุงููุฌุงุญ
            # ูุงูุฑุฏ ุงูุณุงุจู ูุงู ุณูุฑูุจุช ุชุญููู (redirect script)
            # ููุฐุง ูุคูุฏ ุฃู ุงูุฅุถุงูุฉ ูุฌุญุช.
            
            # ุฑุงุญ ููุญุต ุฅุฐุง ูุงู ุงูุฑุฏ ูุญุชูู ุนูู ุณูุฑูุจุช ุงูุชุญููู ุงููู ุดููุงู ุณุงุจูุงู
            if "location.replace" in response.text:
                return "โ ุชู ุฅุถุงูุฉ ุงูุทูุจ ุจูุฌุงุญ (ุชุฃููุฏ ุงููููุน: ุชู ุงูุชุญููู ุฅูู ุณุฌู ุงูุทูุจุงุช)."
            else:
                 # ุฅุฐุง ูู ููุฌุญุ ูุฐุง ูุนูู ุฃู ุงูุชุฎูููุงุช ุงูุฌุฏูุฏุฉ ุฃูุถุงู ูุดูุช
                return f"โ๏ธ ุชู ุฅุฑุณุงู ุงูุทูุจุ ููู ูู ูุชู ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุฅุถุงูุฉ. ุญุงูุฉ ุงูุฑุฏ: {response.status_code}. \n ูุญุชูู ุงูุฑุฏ: {response.text[:100]}..."
        else:
            return f"โ ูุดู ุงูุฅุฑุณุงู. ุญุงูุฉ ุงูุฑุฏ: {response.status_code}. "

    except Exception as e:
        return f"โ ุตุงุฑ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ: {e}"
