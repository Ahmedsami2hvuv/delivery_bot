# الملف: web_actions.py (الإصدار النهائي لحل مشكلة الحقول الناقصة)

import requests
from bs4 import BeautifulSoup
import json
import time

# ************************************************
# 🔴 دالة تنفيذ عملية إضافة الطلب (باستخدام Requests)
# ************************************************
def perform_add_order(order_details: list, delivery_url: str):
    
    # البيانات الأساسية اللي تجينا من التليجرام:
    item_type = order_details[0].strip()    # النوع (مسواك)
    price = order_details[1].strip()        # السعر (12)
    area_name = order_details[2].strip()    # المنطقة (جيكور)
    phone_number = order_details[3].strip() # الرقم (077...)
    time_text = order_details[4].strip()    # الوقت (هسه)
    
    # 🔴 ملاحظة: بما أننا لا نعرف أسماء الحقول الحقيقية في الموقع، سنستخدم
    # تخمينات أكثر شيوعاً ونتأكد من إرسال جميع الحقول الثمانية.
    
    # *******************************************************************
    # 1. مرحلة إعداد البيانات (Payload) 
    # *******************************************************************

    # 🔴 هذا هو الرابط اللي راح نرسل عليه البيانات (غالباً نفس رابط الصفحة)
    post_url = delivery_url 
    
    # 🔴 البيانات اللي لازم يرسلها البوت للموقع (مطابقة لجميع حقول الفورم):
    payload = {
        # الحقول الخمسة اللي دزيتها:
        'type': item_type,             # اسم الحقل لتخمين 'نوع الطلب'
        'price_no_delivery': price,    # اسم الحقل لتخمين 'سعر الطلب'
        'area_name': area_name,        # اسم الحقل لتخمين 'منطقة الزبون'
        'phone': phone_number,         # اسم الحقل لتخمين 'رقم الزبون'
        'order_time': time_text,       # اسم الحقل لتخمين 'وقت الطلب'
        
        # الحقول اللي أكدت إنها 'غير مهمة' (لكن يجب إرسالها فارغة):
        'phone_second': "",            # حقل 'رقم ثاني للزبون' (فارغ)
        'notes': "",                   # حقل 'ملاحظات' (فارغ)
        'image': "",                   # حقل 'صورة الطلبية' (فارغ)
        'is_done': "0",                # حقل تخميني لـ 'كل شي واصل؟' (0 = لا)
        
        # حقل زر الإضافة (مهم للتأكيد):
        'submit': 'إضافة الطلبية'       # تخمين لاسم زر التأكيد
    }
    
    # *******************************************************************
    # 2. مرحلة إرسال الطلب (POST Request)
    # *******************************************************************
    
    try:
        response = requests.post(post_url, data=payload)
        
        # فحص الرد:
        if response.status_code == 200:
            # الموقع رد بكود 200، الآن نحاول التأكد من رسالة النجاح
            
            # بما إنك ذكرت أن الموقع يحمل الصفحة من جديد بعد النجاح
            # والرد السابق كان سكريبت تحويل (redirect script)
            # فهذا يؤكد أن الإضافة نجحت.
            
            # راح نفحص إذا كان الرد يحتوي على سكريبت التحويل اللي شفناه سابقاً
            if "location.replace" in response.text:
                return "✅ تم إضافة الطلب بنجاح (تأكيد الموقع: تم التحويل إلى سجل الطلبات)."
            else:
                 # إذا لم ينجح، هذا يعني أن التخمينات الجديدة أيضاً فشلت
                return f"⚠️ تم إرسال الطلب، لكن لم يتم التأكد من نجاح الإضافة. حالة الرد: {response.status_code}. \n محتوى الرد: {response.text[:100]}..."
        else:
            return f"❌ فشل الإرسال. حالة الرد: {response.status_code}. "

    except Exception as e:
        return f"❌ صار خطأ أثناء إرسال الطلب: {e}"
