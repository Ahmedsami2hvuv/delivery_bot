# ุงูููู: web_actions.py (ุงููุณุฎุฉ ุงูููุงุฆูุฉ ูู Requests)

import requests
from bs4 import BeautifulSoup
import json
import time

# ************************************************
# ๐ด ุฏุงูุฉ ุชูููุฐ ุนูููุฉ ุฅุถุงูุฉ ุงูุทูุจ (ุจุงุณุชุฎุฏุงู Requests)
# ************************************************
def perform_add_order(order_details: list, delivery_url: str):
    
    # ุชูุงุตูู ุงูุทูุจ ุงููู ุชุฌููุง ูู ุงูุชููุฌุฑุงู:
    item_type = order_details[0].strip()    # ุงูููุน (ูุณูุงู)
    price = order_details[1].strip()        # ุงูุณุนุฑ (12)
    area_name = order_details[2].strip()    # ุงูููุทูุฉ (ุฌูููุฑ)
    phone_number = order_details[3].strip() # ุงูุฑูู (077...)
    time_text = order_details[4].strip()    # ุงูููุช (ูุณู)
    
    # *******************************************************************
    # 1. ุงููุฑุญูุฉ ุงูุฃููู: ุงูุญุตูู ุนูู ููุฏ ุงูููุทูุฉ (ุถุฑูุฑู ููุชุทุจูู)
    # *******************************************************************
    try:
        # ๐ด ูุงุฒู ูุณูู ุทูุจ ุจุญุซ ุฎุงุต ุญุชู ูุนุฑู ุงูููุฏ (ID) ูุงู ุงูููุทูุฉ
        # ุญุงููุงูุ ูุง ููุฏุฑ ูุนุฑู ุฑุงุจุท ุงูุจุญุซุ ูุฐูู ุฑุงุญ ููุชุฑุถ ุฅู ุงููููุน ูุญุชุงุฌ ุงุณู ุงูููุทูุฉ ููุท.
        # ุฅุฐุง ูุดูุ ูุญุชุงุฌ ุฑุงุจุท API ุงููููุน. ุญุงููุงู: ููุชุฑุถ ุฅูู ูุง ูุญุชุงุฌ API.
        
        # ุจูุง ุฅู ุงูุฑูุงุจุท ุซุงุจุชุฉุ ุงููููุน ูุทูุจ ID ุฎุงุต ุจุงูููุทูุฉ
        # ููู ููุชุฌุฑุจุฉ ุงููุจุฏุฆูุฉุ ุฑุงุญ ูุณุชุฎุฏู ุงุณู ุงูููุทูุฉ ูุจุงุดุฑุฉ ูู ุญูู Area_Name
        
        # ๐ด ูุญุชุงุฌ ูุญุฏุฏ ID ุงูุญูููู ููููุทูุฉ. ุจูุง ุฅููุง ูุง ุนูุฏูุง APIุ ุฑุงุญ ููุชุฑุถ ID ุงูุชุฑุงุถู ูุคูุชุงู
        # (ุงุฐุง ูุดู ุงูููุฏุ ุณูุญุชุงุฌ ููู ุชูุงุตูู ุฃูุซุฑ ุนู ุงูููุทูุฉ)
        area_id = area_name 

    except Exception as e:
         return f"โ ูุดู: ูู ูุชููู ูู ุชุญุฏูุฏ ููุฏ ุงูููุทูุฉ. (ุงูุฎุทูุฉ ุฑูู 102)"

    # *******************************************************************
    # 2. ุงููุฑุญูุฉ ุงูุซุงููุฉ: ุฅุฑุณุงู ุงูุทูุจ (POST Request)
    # *******************************************************************
    
    # ๐ด ูุฐุง ูู ุงูุฑุงุจุท ุงููู ุฑุงุญ ูุฑุณู ุนููู ุงูุจูุงูุงุช (ุบุงูุจุงู ูู ููุณู ุฑุงุจุท ุงูุตูุญุฉ)
    # ๐ด ุบุงูุจุงู ุงูุทูุจ ูููู ุนูู ุฑุงุจุท ุขุฎุฑุ ููู ููุชุฑุถ ุฅูู ุฑุงุจุท ุงูุตูุญุฉ ูุคูุชุงู
    post_url = delivery_url 
    
    # ๐ด ุงูุจูุงูุงุช ุงููู ูุงุฒู ูุฑุณููุง ุงูุจูุช ูููููุน:
    # (ูุงู ุงูุฃุณูุงุก ูู ุชุฎููููุฉ ููุญูููุ ูุงุฒู ุชุชุบูุฑ ููุฃุณูุงุก ุงูุญููููุฉ ุงููู ูุณุชุฎุฏููุง ุงููููุน)
    payload = {
        'order_type': item_type,       # ููุน ุงูุทูุจูุฉ
        'price_delivery_less': price,  # ุงูุณุนุฑ ุจุฏูู ุชูุตูู
        'area_search': area_id,        # ุงุณู/ููุฏ ุงูููุทูุฉ
        'customer_phone': phone_number, # ุฑูู ุงูุฒุจูู
        'order_time': time_text,       # ููุช ุงูุทูุจ
        'submit_button': 'ุฅุถุงูุฉ ุงูุทูุจูุฉ' # ุฒุฑ ุงูุชุฃููุฏ (ุงุณู ุงูุฒุฑ ุงูุญูููู)
        # ูููู ูุญุชุงุฌ ูุถูู ุญููู ูุฎููุฉ (csrf tokens) ุฅุฐุง ุงููููุน ูุชุทูุจ ุฃูุงู
    }
    
    # ุฅุฑุณุงู ุงูุจูุงูุงุช
    try:
        response = requests.post(post_url, data=payload)
        
        # ูุญุต ุงูุฑุฏ:
        if response.status_code == 200:
            # ๐ด ุงูุจุญุซ ุนู ุฑุณุงูุฉ ุงููุฌุงุญ ูู ูุญุชูู ุงูุตูุญุฉ ุงููู ุฑุฌุนุช
            soup = BeautifulSoup(response.text, 'html.parser')
            success_div = soup.find('div', class_='success-message') # ุชุฎูููู
            
            if success_div or "ุณุฌู ุงูุทูุจุงุช" in response.text:
                return "โ ุชู ุฅุถุงูุฉ ุงูุทูุจ ุจูุฌุงุญ. (ุชู ุงูุฅุฑุณุงู ุนุจุฑ requests)"
            else:
                return f"โ๏ธ ุชู ุฅุฑุณุงู ุงูุทูุจุ ููู ูู ูุชู ุงูุชุฃูุฏ ูู ูุฌุงุญ ุงูุฅุถุงูุฉ. ุญุงูุฉ ุงูุฑุฏ: {response.status_code}. \nูุญุชูู ุงูุฑุฏ: {response.text[:100]}..."
        else:
            return f"โ ูุดู ุงูุฅุฑุณุงู. ุญุงูุฉ ุงูุฑุฏ: {response.status_code}. "

    except Exception as e:
        return f"โ ุตุงุฑ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุทูุจ: {e}"
